{% extends "base.html" %}
{% block title %}Automation Rules - Lust Rentals{% endblock %}
{% block head_extra %}
    <style>
        /* Theme-aware styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-app);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 2rem; border-radius: 14px;
            margin-bottom: 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { color: var(--text-primary); }
        .header p { color: var(--text-secondary); }
        
        .content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 2rem; border-radius: 14px;
        }
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 10px;
            font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 0.5rem;
            color: white;
        }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--secondary); }
        .btn-danger { background: var(--danger); }
        .btn-small { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        th { background: var(--bg-card-hover); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.8rem; }
        td code { background: var(--bg-card-hover); padding: 0.2rem 0.5rem; border-radius: 4px; color: var(--warning); }
        td b { color: var(--secondary); }
        td strong { color: var(--text-primary); }
        
        .badge {
            padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;
        }
        .badge-cat { background: rgba(59, 130, 246, 0.2); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.35); }
        .badge-prop { background: rgba(34, 197, 94, 0.2); color: var(--secondary); border: 1px solid rgba(34, 197, 94, 0.35); }
        .badge-multi { background: rgba(251, 191, 36, 0.2); color: var(--warning); border: 1px solid rgba(251, 191, 36, 0.35); }

        .action-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .action-row button {
            padding: 0.4rem 0.6rem;
        }
        .action-lines {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .action-line {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 2rem; border-radius: 14px;
            width: 500px; max-width: 90%;
            color: var(--text-primary);
        }
        .modal-content h2 { color: var(--text-primary); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary); }
        .form-group input, .form-group select {
            width: 100%; padding: 0.75rem; 
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container">

        <div class="header">
            <div>
                <h1>&#9881; Automation Rules</h1>
                <p style="color: var(--gray);">Define rules to automatically categorize transactions</p>
            </div>
            <button class="btn btn-success" onclick="showAddModal()">+ Add Rule</button>
        </div>

        <div class="content">
            <div id="alert" style="display:none; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;"></div>
            
            <table>
                <thead>
                    <tr>
                        <th>Rule Name</th>
                        <th>Criteria</th>
                        <th>Action</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="rules-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="rule-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 1.5rem;">Add Rule</h2>
            <form id="rule-form" onsubmit="saveRule(event)">
                <div class="form-group">
                    <label>Rule Name</label>
                    <input type="text" id="rule-name" required placeholder="e.g. Home Depot Repairs">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>If Field...</label>
                        <select id="criteria-field">
                            <option value="description">Description</option>
                            <option value="memo">Memo</option>
                            <option value="amount">Amount</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Matches...</label>
                        <select id="criteria-match-type">
                            <option value="contains">Contains</option>
                            <option value="starts_with">Starts With</option>
                            <option value="equals">Equals</option>
                            <option value="regex">Regex Pattern</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Value</label>
                    <input type="text" id="criteria-value" required placeholder="e.g. Home Depot">
                </div>

                <div style="border-top: 1px solid #eee; margin: 1.5rem 0;"></div>

                <div class="form-group">
                    <label>Then Apply Actions...</label>
                    <div id="actions-container"></div>
                    <button type="button" class="btn btn-small btn-primary" onclick="addActionRow()">+ Add Action</button>
                </div>

                <datalist id="categories-list">
                    <!-- Populated via JS -->
                </datalist>
                <datalist id="properties-list">
                    <!-- Populated via JS -->
                </datalist>

                <div class="form-group">
                    <label>Priority (Higher runs first)</label>
                    <input type="number" id="rule-priority" value="10">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn" style="background:var(--gray)" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Rule</button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}
{% block scripts %}
    <script>
        const API_BASE = window.location.origin;
        let rules = [];
        let editingId = null;
        let properties = [];
        let categories = [];

        window.onload = async () => {
            await Promise.all([loadRules(), loadMetadata()]);
        };

        async function loadMetadata() {
            try {
                const [propsResp, catsResp] = await Promise.all([
                    fetch(`${API_BASE}/review/properties`),
                    fetch(`${API_BASE}/review/categories`)
                ]);
                properties = await propsResp.json();
                categories = await catsResp.json();
                updateDataList();
            } catch (e) { console.error(e); }
        }

        function updateDataList() {
            const categoriesList = document.getElementById('categories-list');
            const propertiesList = document.getElementById('properties-list');
            categoriesList.innerHTML = '';
            propertiesList.innerHTML = '';
            categories.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                categoriesList.appendChild(option);
            });
            properties.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                propertiesList.appendChild(option);
            });
        }

        async function loadRules() {
            const res = await fetch(`${API_BASE}/rules/`);
            rules = await res.json();
            renderRules();
        }

        function renderRules() {
            const tbody = document.getElementById('rules-tbody');
            tbody.innerHTML = rules.map(rule => `
                <tr>
                    <td><strong>${rule.name}</strong></td>
                    <td>If <code>${rule.criteria_field}</code> ${rule.criteria_match_type} "<b>${rule.criteria_value}</b>"</td>
                    <td>${renderActions(rule)}</td>
                    <td>${rule.priority}</td>
                    <td>${rule.is_active ? '✅' : '❌'}</td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="editRule(${rule.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteRule(${rule.id})">Del</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddModal() {
            editingId = null;
            document.getElementById('modal-title').innerText = 'Add Rule';
            document.getElementById('rule-form').reset();
            document.getElementById('rule-modal').classList.add('show');
            updateDataList();
            resetActions();
        }

        function closeModal() {
            document.getElementById('rule-modal').classList.remove('show');
        }

        function editRule(id) {
            const rule = rules.find(r => r.id === id);
            editingId = id;
            document.getElementById('modal-title').innerText = 'Edit Rule';
            document.getElementById('rule-name').value = rule.name;
            document.getElementById('criteria-field').value = rule.criteria_field;
            document.getElementById('criteria-match-type').value = rule.criteria_match_type;
            document.getElementById('criteria-value').value = rule.criteria_value;
            resetActions(rule);
            document.getElementById('rule-priority').value = rule.priority;
            document.getElementById('rule-modal').classList.add('show');
        }

        async function saveRule(e) {
            e.preventDefault();
            const actions = collectActions();
            if (actions.length === 0) {
                alert('Please add at least one action.');
                return;
            }

            const data = {
                name: document.getElementById('rule-name').value,
                criteria_field: document.getElementById('criteria-field').value,
                criteria_match_type: document.getElementById('criteria-match-type').value,
                criteria_value: document.getElementById('criteria-value').value,
                action_type: actions.length > 1 ? 'multi' : actions[0].type,
                action_value: actions.length > 1 ? actions : actions[0].value,
                priority: parseInt(document.getElementById('rule-priority').value)
            };

            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `${API_BASE}/rules/${editingId}` : `${API_BASE}/rules/`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal();
                    loadRules();
                } else {
                    alert('Error saving rule');
                }
            } catch (err) {
                console.error(err);
                alert('Error saving rule');
            }
        }

        async function deleteRule(id) {
            if (!confirm('Are you sure?')) return;
            await fetch(`${API_BASE}/rules/${id}`, { method: 'DELETE' });
            loadRules();
        }

        function parseActions(rule) {
            if (Array.isArray(rule.action_value)) {
                return rule.action_value;
            }
            if (typeof rule.action_value === 'string' && rule.action_value.trim().startsWith('[')) {
                try {
                    const parsed = JSON.parse(rule.action_value);
                    if (Array.isArray(parsed)) return parsed;
                } catch (e) {}
            }
            if (rule.action_type && rule.action_value) {
                return [{ type: rule.action_type, value: rule.action_value }];
            }
            return [];
        }

        function renderActions(rule) {
            const actions = parseActions(rule);
            if (!actions.length) return '';
            return `
                <div class="action-lines">
                    ${actions.map(action => `
                        <div class="action-line">
                            <span class="badge ${action.type === 'set_category' ? 'badge-cat' : action.type === 'set_property' ? 'badge-prop' : 'badge-multi'}">
                                ${action.type === 'set_category' ? 'Category' : action.type === 'set_property' ? 'Property' : action.type}
                            </span>
                            = ${action.value}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function resetActions(rule = null) {
            const container = document.getElementById('actions-container');
            container.innerHTML = '';
            const actions = rule ? parseActions(rule) : [{ type: 'set_category', value: '' }];
            actions.forEach(action => addActionRow(action));
        }

        function addActionRow(action = { type: 'set_category', value: '' }) {
            const container = document.getElementById('actions-container');
            const row = document.createElement('div');
            row.className = 'action-row';

            const typeSelect = document.createElement('select');
            typeSelect.innerHTML = `
                <option value="set_category">Set Category</option>
                <option value="set_property">Set Property</option>
            `;
            typeSelect.value = action.type || 'set_category';

            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.required = true;
            valueInput.value = action.value || '';
            valueInput.setAttribute('list', typeSelect.value === 'set_category' ? 'categories-list' : 'properties-list');

            typeSelect.addEventListener('change', () => {
                valueInput.value = '';
                valueInput.setAttribute('list', typeSelect.value === 'set_category' ? 'categories-list' : 'properties-list');
            });

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-small btn-danger';
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => row.remove();

            row.appendChild(typeSelect);
            row.appendChild(valueInput);
            row.appendChild(removeButton);
            container.appendChild(row);
        }

        function collectActions() {
            const container = document.getElementById('actions-container');
            const rows = Array.from(container.querySelectorAll('.action-row'));
            return rows.map(row => {
                const [typeSelect, valueInput] = row.querySelectorAll('select, input');
                return { type: typeSelect.value, value: valueInput.value.trim() };
            }).filter(action => action.value);
        }
    </script>
{% endblock %}
